syntax = "proto3";

package shared.proto.services.v1;

import "core/crypto.proto";
import "core/envelope.proto";
import "core/identity.proto";
import "core/pagination.proto";
import "messaging/content.proto";
import "signaling/presence.proto";

// MessagingService - Core messaging gRPC service
// Handles sending, receiving, and querying messages
service MessagingService {
  // === Bidirectional Streaming (Primary API) ===

  // MessageStream - Bidirectional message stream
  // Client sends messages, server pushes incoming messages
  // Long-lived connection for real-time messaging
  rpc MessageStream(stream MessageStreamRequest) returns (stream MessageStreamResponse);

  // === Unary RPCs (Query APIs) ===

  // GetInbox - Fetch user's inbox with pagination
  // Returns list of conversations with latest message
  rpc GetInbox(GetInboxRequest) returns (shared.proto.core.v1.PageResponse);

  // GetHistory - Fetch conversation history with pagination
  // Returns messages in a specific conversation
  rpc GetHistory(GetHistoryRequest) returns (shared.proto.core.v1.PageResponse);

  // SendMessage - Send single message (alternative to stream)
  // Use for one-off messages, prefer MessageStream for active sessions
  rpc SendMessage(SendMessageRequest) returns (SendMessageResponse);

  // DeleteMessage - Delete message (for self or everyone)
  rpc DeleteMessage(DeleteMessageRequest) returns (DeleteMessageResponse);

  // EditMessage - Edit existing message
  rpc EditMessage(EditMessageRequest) returns (EditMessageResponse);

}

// MessageStreamRequest - Client -> Server in bidirectional stream
message MessageStreamRequest {
  // Request type (determines which field is populated)
  oneof request {
    // Send message
    shared.proto.core.v1.Envelope send = 1;

    // Send receipt
    shared.proto.signaling.v1.DeliveryReceipt receipt = 2;

    // Typing indicator
    shared.proto.signaling.v1.TypingIndicator typing = 3;

    // Subscribe to conversations (request push for these)
    SubscribeRequest subscribe = 4;

    // Unsubscribe from conversations
    UnsubscribeRequest unsubscribe = 5;

    // Heartbeat/keepalive
    Heartbeat heartbeat = 6;
  }

  // Request ID (for correlation)
  string request_id = 10;

  // Reserved for future request types
  reserved 7 to 9, 11 to 20;
}

// MessageStreamResponse - Server -> Client in bidirectional stream
message MessageStreamResponse {
  // Response type (determines which field is populated)
  oneof response {
    // Incoming message
    shared.proto.core.v1.Envelope message = 1;

    // Incoming receipt
    shared.proto.signaling.v1.DeliveryReceipt receipt = 2;

    // Typing indicator from other user
    shared.proto.signaling.v1.TypingIndicator typing = 3;

    // Message sent acknowledgment
    MessageAck ack = 4;

    // Message send failed
    MessageError error = 5;

    // Presence update (user online/offline)
    shared.proto.signaling.v1.PresenceUpdate presence = 6;

    // Heartbeat response
    HeartbeatAck heartbeat_ack = 7;
  }

  // Response ID (correlates to request_id)
  optional string response_id = 10;

  // Reserved for future response types
  reserved 8 to 9, 11 to 20;
}

// SubscribeRequest - Subscribe to conversation updates
message SubscribeRequest {
  // Conversation IDs to subscribe to
  repeated string conversation_ids = 1;

  // Subscribe to presence updates for these users?
  bool include_presence = 2;
}

// UnsubscribeRequest - Unsubscribe from conversation updates
message UnsubscribeRequest {
  // Conversation IDs to unsubscribe from
  repeated string conversation_ids = 1;
}

// Heartbeat - Keepalive ping
message Heartbeat {
  // Timestamp
  int64 timestamp = 1;
}

// HeartbeatAck - Keepalive pong
message HeartbeatAck {
  // Echo timestamp
  int64 timestamp = 1;

  // Server timestamp
  int64 server_timestamp = 2;
}

// MessageAck - Message successfully sent
message MessageAck {
  // Original message ID
  string message_id = 1;

  // Server-assigned message number
  uint64 message_number = 2;

  // Server timestamp
  int64 server_timestamp = 3;

  // Delivered to how many recipients/devices?
  uint32 delivery_count = 4;
}

// MessageError - Message send failed
message MessageError {
  // Original message ID
  string message_id = 1;

  // Error code
  ErrorCode error_code = 2;

  // Error message (human-readable)
  string error_message = 3;

  // Retry allowed?
  bool retryable = 4;
}

// ErrorCode - Message error codes
enum ErrorCode {
  // Unspecified error (must be 0)
  ERROR_CODE_UNSPECIFIED = 0;

  // Recipient not found
  ERROR_CODE_RECIPIENT_NOT_FOUND = 1;

  // Recipient blocked sender
  ERROR_CODE_BLOCKED = 2;

  // Rate limit exceeded
  ERROR_CODE_RATE_LIMIT = 3;

  // Message too large
  ERROR_CODE_TOO_LARGE = 4;

  // Invalid encryption (E2EE failed)
  ERROR_CODE_ENCRYPTION_FAILED = 5;

  // Recipient offline (no push token)
  ERROR_CODE_OFFLINE = 6;

  // Reserved for future errors
  reserved 7 to 20;
}

// GetInboxRequest - Fetch user's inbox
message GetInboxRequest {
  // Pagination
  shared.proto.core.v1.PageRequest page = 1;

  // Filter by conversation type (optional)
  optional shared.proto.core.v1.ConversationType filter_type = 2;

  // Filter by unread status (optional)
  optional bool unread_only = 3;

  // Reserved for future filters
  reserved 4 to 10;
}

// GetHistoryRequest - Fetch conversation history
message GetHistoryRequest {
  // Conversation ID (required)
  string conversation_id = 1;

  // Pagination
  shared.proto.core.v1.PageRequest page = 2;

  // Filter by content type (optional)
  repeated shared.proto.core.v1.ContentType filter_types = 3;

  // Search query (optional, E2EE requires client-side)
  optional string search_query = 4;

  // Time range filter (optional)
  optional shared.proto.core.v1.TimeRange time_range = 5;

  // Reserved for future filters
  reserved 6 to 10;
}

// SendMessageRequest - Send single message (unary RPC)
message SendMessageRequest {
  // Message envelope
  shared.proto.core.v1.Envelope message = 1;

  // Idempotency key (prevent duplicate sends)
  optional string idempotency_key = 2;

  // Reserved for future features
  reserved 3 to 10;
}

// SendMessageResponse - Send message response
message SendMessageResponse {
  // Message ID (echo back)
  string message_id = 1;

  // Server-assigned message number
  uint64 message_number = 2;

  // Server timestamp
  int64 server_timestamp = 3;

  // Success
  bool success = 4;

  // Error (if failed)
  optional MessageError error = 5;
}


// DeleteMessageRequest - Delete message
message DeleteMessageRequest {
  // Message ID to delete
  string message_id = 1;

  // Conversation ID
  string conversation_id = 2;

  // Delete for everyone or just self?
  shared.proto.messaging.v1.DeleteScope scope = 3;

  // Reserved for future features
  reserved 4 to 10;
}

// DeleteMessageResponse - Delete confirmation
message DeleteMessageResponse {
  // Success
  bool success = 1;

  // Deleted timestamp
  int64 deleted_at = 2;
}

// EditMessageRequest - Edit message
message EditMessageRequest {
  // Message ID to edit
  string message_id = 1;

  // Conversation ID
  string conversation_id = 2;

  // New content (encrypted)
  bytes new_encrypted_content = 3;

  // Reserved for future features
  reserved 4 to 10;
}

// EditMessageResponse - Edit confirmation
message EditMessageResponse {
  // Success
  bool success = 1;

  // Edited timestamp
  int64 edited_at = 2;

  // Edit count
  uint32 edit_count = 3;
}


