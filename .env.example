# Database configuration
DATABASE_URL="postgresql://user:password@host:port/database"

# Redis configuration
REDIS_URL=redis://127.0.0.1:6379

# Server configuration
# Port to bind the WebSocket server (default: 8080)
PORT=8080

# JWT Secret for signing authentication tokens
# THIS MUST BE AT LEAST 32 CHARACTERS LONG AND KEPT SECRET
JWT_SECRET=

# Salt for hashing user identifiers in logs
# THIS MUST BE A UNIQUE, SECRET VALUE. DO NOT USE THE DEFAULT VALUE.
LOG_HASH_SALT=

# Message queue TTL in days (default: 7)
# How long offline messages are stored in Redis before expiring
MESSAGE_TTL_DAYS=7

# Rate Limiting & Security
MAX_MESSAGES_PER_HOUR=1000        # Maximum messages per user per hour
MAX_KEY_ROTATIONS_PER_DAY=10      # Maximum key rotations per user per day
MAX_PASSWORD_CHANGES_PER_DAY=5    # Maximum password changes per user per day
MAX_FAILED_LOGIN_ATTEMPTS=5       # Maximum failed login attempts before 15-minute lockout
DELIVERY_POLL_INTERVAL_MS=10000

# Delivery Worker Configuration
ONLINE_CHANNEL=user_online_notifications  # Redis Pub/Sub channel for user online notifications
DELIVERY_QUEUE_PREFIX=queue
OFFLINE_QUEUE_PREFIX=offline

# Kafka Configuration (Phase 1+)
# Enable Kafka for reliable message delivery (default: false)
# Set to true to enable dual-write (Phase 2) or Kafka-only (Phase 6)
KAFKA_ENABLED=false

# Kafka brokers (comma-separated list)
# Development: localhost:9092
# Production: kafka1:9092,kafka2:9092,kafka3:9092
KAFKA_BROKERS=localhost:9092

# Kafka topic for messages (default: construct-messages)
KAFKA_TOPIC=construct-messages

# Kafka consumer group for delivery workers (default: construct-delivery-workers)
KAFKA_CONSUMER_GROUP=construct-delivery-workers

# Kafka Security (optional, for production)
# Enable SSL/TLS encryption
KAFKA_SSL_ENABLED=false

# SASL authentication mechanism (e.g., SCRAM-SHA-256, PLAIN)
# KAFKA_SASL_MECHANISM=SCRAM-SHA-256
# KAFKA_SASL_USERNAME=construct_user
# KAFKA_SASL_PASSWORD=secret

# APNs Configuration (Apple Push Notifications)
# IMPORTANT: Notifications are OPT-IN only! Users must explicitly register their device.
# Default mode: Pull-only (client polls every 10-15 minutes via Background App Refresh)
# Optional mode: Silent Push (background sync when APNs enabled)

# Enable push notifications (default: false)
APNS_ENABLED=false

# APNs environment: "production" or "development"
APNS_ENVIRONMENT=development

# APNs authentication key file path (relative to project root)
# Download .p8 file from Apple Developer portal
APNS_KEY_PATH=AuthKey_XXXXXXXXXX.p8

# APNs Key ID (10 characters, found in Apple Developer portal)
APNS_KEY_ID=XXXXXXXXXX

# APNs Team ID (found in Apple Developer portal)
APNS_TEAM_ID=XXXXXXXXXX

# iOS app Bundle ID (e.g., com.example.construct)
APNS_BUNDLE_ID=com.example.construct

# APNs topic (usually same as Bundle ID)
APNS_TOPIC=com.example.construct

# Device token encryption key (REQUIRED - MUST BE CHANGED FROM DEFAULT!)
# Generate with: openssl rand -hex 32
# This encrypts device tokens in database for privacy
# If DB is compromised, attacker cannot spam push notifications
APNS_DEVICE_TOKEN_ENCRYPTION_KEY=CHANGE_ME_GENERATE_WITH_OPENSSL_RAND_HEX_32
# The TTL in seconds for the server instance's registration key in Redis.
# This should be at least 2x the HEARTBEAT_INTERVAL_SECS.
HEARTBEAT_INTERVAL_SECS=90
SERVER_REGISTRY_TTL_SECS=180

# Delivery ACK System (Privacy-Preserving Message Delivery Confirmations)
# ============================================================================
# This system tracks when offline messages are delivered to recipients and
# sends "delivered" ACK back to the sender WITHOUT revealing the relationship
# between messages and senders to the server.
#
# How it works:
# 1. When a message is queued, server stores HMAC-SHA256(messageId) -> senderId
# 2. When recipient gets the message, they send acknowledgment with messageId
# 3. Server computes HMAC-SHA256(messageId), looks up senderId, sends ACK
# 4. Records are automatically deleted after delivery or expiry
#
# Privacy properties:
# - Server cannot determine who sent what message without SECRET_KEY
# - Even with DB access, cannot reconstruct communication graph
# - Automatic data deletion minimizes retention
#
# To enable: Set DELIVERY_SECRET_KEY (optional, system disabled if not set)
# To generate key: Run ./scripts/generate_delivery_key.sh
# ============================================================================

# Secret key for HMAC-SHA256 hashing (REQUIRED to enable delivery ACK)
# CRITICAL: Must be 32 bytes (64 hex characters)
# CRITICAL: Keep this secret! Store in secrets manager in production
# CRITICAL: Never commit to git
# CRITICAL: Use different keys for dev/staging/prod
# Generate with: ./scripts/generate_delivery_key.sh OR openssl rand -hex 32
#DELIVERY_SECRET_KEY=

# Number of days before delivery pending records expire (default: 7)
# After this time, undelivered ACKs are automatically cleaned up
DELIVERY_EXPIRY_DAYS=7

# Cleanup interval in seconds (default: 3600 = 1 hour)
# How often to run background task that removes expired records
DELIVERY_CLEANUP_INTERVAL_SECS=3600
