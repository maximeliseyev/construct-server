# ============================================================================
# Construct Server - Production Environment Configuration
# ============================================================================
# Copy this file to .env.prod and fill in the values
# DO NOT commit .env.prod to version control
#
# This configuration supports multi-server architecture:
# - Gateway Server: Load balancer + API Gateway
# - Core Server: Auth, User, Notification services + PostgreSQL + Redis Primary
# - Message Server: Messaging service, Delivery Worker + Redpanda + Redis Replica
# - Media Server: Media service + monitoring (optional)

# ============================================================================
# INFRASTRUCTURE CONFIGURATION
# ============================================================================
# Domain name for the production deployment
DOMAIN_NAME=your-domain.com

# Database password (used across all servers)
DB_PASSWORD=your-secure-database-password

# Redis password (used across all servers)
REDIS_PASSWORD=your-secure-redis-password

# JWT secret (256-bit hex, generate with: openssl rand -hex 32)
JWT_SECRET=your-256-bit-jwt-secret-hex

# APNS encryption key (64 hex characters, generate with: openssl rand -hex 32)
APNS_DEVICE_TOKEN_ENCRYPTION_KEY=your-64-char-apns-encryption-key

# Log hash salt for anonymizing logs (64 hex characters)
LOG_HASH_SALT=your-64-char-log-hash-salt

# ============================================================================
# DATABASE CONFIGURATION
# ============================================================================
# For Database Server: Use localhost since DB runs locally
DATABASE_URL=postgresql://construct:${DB_PASSWORD}@localhost:5432/construct

# For Application Server: Connect to dedicated database server
# DATABASE_URL=postgresql://construct:${DB_PASSWORD}@db.internal:5432/construct

# For Message Server: Connect to dedicated database server
# DATABASE_URL=postgresql://construct:${DB_PASSWORD}@db.internal:5432/construct

# ============================================================================
# REDIS CONFIGURATION
# ============================================================================
# For Database Server: Use localhost for primary Redis
REDIS_URL=redis://:${REDIS_PASSWORD}@localhost:6379

# For Application Server: Connect to database server Redis
# REDIS_URL=redis://:${REDIS_PASSWORD}@db.internal:6379

# For Message Server: Use localhost for Redis replica
# REDIS_URL=redis://:${REDIS_PASSWORD}@localhost:6379

# For Gateway Server: Connect to database server Redis
# REDIS_URL=redis://:${REDIS_PASSWORD}@db.internal:6379

# ============================================================================
# JWT CONFIGURATION
# ============================================================================
JWT_SECRET=${JWT_SECRET}
JWT_ISSUER=prod-construct-
ACCESS_TOKEN_TTL_MINUTES=60
REFRESH_TOKEN_TTL_DAYS=30

# ============================================================================
# SERVER CONFIGURATION
# ============================================================================
RUST_LOG=info
INSTANCE_DOMAIN=${DOMAIN_NAME}
FEDERATION_BASE_DOMAIN=${DOMAIN_NAME}
FEDERATION_ENABLED=false
DEEP_LINK_BASE_URL=https://${DOMAIN_NAME}

# ============================================================================
# SECURITY CONFIGURATION
# ============================================================================
# Rate Limiting
MAX_MESSAGES_PER_HOUR=1000
MAX_KEY_ROTATIONS_PER_DAY=10
MAX_PASSWORD_CHANGES_PER_DAY=5
MAX_FAILED_LOGIN_ATTEMPTS=5
MAX_CONNECTIONS_PER_USER=5

# Cryptography
APNS_DEVICE_TOKEN_ENCRYPTION_KEY=${APNS_DEVICE_TOKEN_ENCRYPTION_KEY}

# ============================================================================
# MESSAGE CONFIGURATION
# ============================================================================
MESSAGE_TTL_DAYS=7
PREKEY_TTL_DAYS=30
PREKEY_MIN_TTL_DAYS=7
PREKEY_MAX_TTL_DAYS=90

# ============================================================================
# DELIVERY WORKER CONFIGURATION
# ============================================================================
ONLINE_CHANNEL=user_online_notifications:
DELIVERY_QUEUE_PREFIX=delivery_queue:
OFFLINE_QUEUE_PREFIX=offline:
DELIVERY_POLL_INTERVAL_MS=10000

# ============================================================================
# KAFKA CONFIGURATION (Optional - for production messaging)
# ============================================================================
KAFKA_ENABLED=true
KAFKA_PRODUCER_COMPRESSION=snappy
KAFKA_PRODUCER_LINGER_MS=5
KAFKA_PRODUCER_ACKS=all
KAFKA_TOPIC=construct-messages
KAFKA_CONSUMER_GROUP=construct-delivery-workers
KAFKA_BROKERS=${KAFKA_BROKERS}
KAFKA_SSL_ENABLED=true
KAFKA_SASL_MECHANISM=PLAIN
KAFKA_SASL_USERNAME=${KAFKA_SASL_USERNAME}
KAFKA_SASL_PASSWORD=${KAFKA_SASL_PASSWORD}

# ============================================================================
# MICROSERVICES CONFIGURATION
# ============================================================================
# For Gateway Server: Route to internal services via private DNS
MICROSERVICES_ENABLED=true
AUTH_SERVICE_URL=http://app.internal:8001
USER_SERVICE_URL=http://app.internal:8002
NOTIFICATION_SERVICE_URL=http://app.internal:8003
MESSAGING_SERVICE_URL=http://message.internal:8004
MEDIA_SERVICE_URL=http://media.internal:8005

# Circuit breaker configuration
SERVICE_TIMEOUT_SECS=30
CIRCUIT_BREAKER_FAILURE_THRESHOLD=5
CIRCUIT_BREAKER_SUCCESS_THRESHOLD=2
CIRCUIT_BREAKER_TIMEOUT_SECS=60
SERVICE_DISCOVERY_MODE=static

# ============================================================================
# MONITORING & LOGGING
# ============================================================================
LOG_MESSAGE_METADATA=false
LOG_USER_IDENTIFIERS=false
LOG_HASH_SALT=${LOG_HASH_SALT}

# ============================================================================
# OPTIONAL: Key Management System (Vault)
# ============================================================================
# VAULT_ADDR=https://vault.example.com:8200
# VAULT_TOKEN=${VAULT_TOKEN}
# KEY_ROTATION_INTERVAL_HOURS=24

# ============================================================================
# OPTIONAL: APNs (Apple Push Notifications)
# ============================================================================
# APNS_ENABLED=true
# APNS_ENVIRONMENT=production
# APNS_KEY_ID=${APNS_KEY_ID}
# APNS_TEAM_ID=${APNS_TEAM_ID}
# APNS_BUNDLE_ID=com.example.construct

# ============================================================================
# OPTIONAL: Federation (Cross-server messaging)
# ============================================================================
# FEDERATION_ENABLED=true
# FEDERATION_PRIVATE_KEY_SEED=${FEDERATION_PRIVATE_KEY_SEED}