# Construct Server Gateway Configuration
# Handles SSL termination, load balancing, and routing

# Main domain
{$DOMAIN_NAME} {
    # Enable automatic HTTPS
    tls {
        protocols tls1.2 tls1.3
    }

    # Security headers
    header {
        # Security headers
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"

        # Remove server header
        -Server
    }

    # Rate limiting
    rate_limit {
        zone static {
            key static
            window 1m
            events 100
        }
    }

    # API routing
    handle /api/v1/* {
        # Route to internal services based on path
        route {
            # Auth endpoints
            @auth {
                path /api/v1/auth/*
            }
            handle @auth {
                reverse_proxy core.internal:8001
            }

            # User endpoints
            @user {
                path /api/v1/users/*
            }
            handle @user {
                reverse_proxy core.internal:8002
            }

            # Message endpoints
            @messages {
                path /api/v1/messages/*
            }
            handle @messages {
                reverse_proxy message.internal:8004
            }

            # Notification endpoints
            @notifications {
                path /api/v1/notifications/*
            }
            handle @notifications {
                reverse_proxy core.internal:8003
            }

            # Media endpoints (if enabled)
            @media {
                path /api/v1/media/*
            }
            handle @media {
                reverse_proxy media.internal:8005
            }
        }
    }

    # Health check endpoint
    handle /health {
        respond "OK" 200
    }

    # WebSocket support for real-time messaging
    handle /ws {
        reverse_proxy message.internal:8004
    }

    # Static files (if any)
    handle {
        try_files {path} {path}/ /index.html
        root * /var/www/html
        file_server
    }
}

# Redirect HTTP to HTTPS
http://{$DOMAIN_NAME} {
    redir https://{host}{uri} permanent
}

# Default HTTP fallback
:80 {
    respond "Construct Server - Use HTTPS" 200
}