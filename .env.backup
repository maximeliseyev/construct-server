# Database configuration
DATABASE_URL=postgresql://postgres:qoqjug-simpu7-qoVsin@db.fyeswytcztcsdsruxxsh.supabase.co:5432/postgres

# Redis configuration
REDIS_URL=rediss://default:AXquAAIncDFjODUzYjQzMzM1YjM0ODJmYTU2ZTgyZTEyMDQzYzI0NnAxMzE0MDY@gentle-moth-31406.upstash.io:6379

# JWT_SECRET=N5spa2sVAKcbo7BN0VCSwKhUCu6WzBIB4PT+eKBdr0eaia41GxMRB3z5IPT4+Ub3g/uMdKpss0GpMH+NsN5zvQ==
JWT_ISSUER=construct-server-fly

JWT_PRIVATE_KEY=prkeys/jwt_private_key.pem
JWT_PUBLIC_KEY=prkeys/jwt_public_key.pem

# Server Ports
PORT=8080
HEALTH_PORT=8081

RUST_LOG=debug

# TTL Configuration
MESSAGE_TTL_DAYS=7           # Messages expire after 7 days
SESSION_TTL_DAYS=30          # Sessions expire after 30 days
REFRESH_TOKEN_TTL_DAYS=90    # Refresh tokens expire after 90 days

# server registry
HEARTBEAT_INTERVAL_SECS=90
SERVER_REGISTRY_TTL_SECS=270

# Cryptographic Key Management
PREKEY_TTL_DAYS=30           # Default prekey lifetime: 30 days
PREKEY_MIN_TTL_DAYS=7        # Minimum allowed prekey lifetime
PREKEY_MAX_TTL_DAYS=90       # Maximum allowed prekey lifetime

MAX_KEY_ROTATIONS_PER_DAY=10
MAX_PASSWORD_CHANGES_PER_DAY=5
MAX_CONNECTIONS_PER_USER=5
KEY_BUNDLE_CACHE_HOURS=1

# Rate Limiting & Security
MAX_MESSAGES_PER_HOUR=1000        # Maximum messages per user per hour
MAX_KEY_ROTATIONS_PER_DAY=10      # Maximum key rotations per user per day
MAX_PASSWORD_CHANGES_PER_DAY=5    # Maximum password changes per user per day
MAX_FAILED_LOGIN_ATTEMPTS=5       # Maximum failed login attempts before 15-minute lockout
MAX_CONNECTIONS_PER_USER=5        # Maximum concurrent connections per user
KEY_BUNDLE_CACHE_HOURS=1          # Hours to cache public key bundles in Redis

# Long-polling rate limits (GET /messages)
MAX_LONG_POLL_REQUESTS_PER_WINDOW=100  # Maximum long-poll requests per window
LONG_POLL_RATE_LIMIT_WINDOW_SECS=60    # Window size in seconds (100 req/60s = ~1.6 req/sec)
DELIVERY_POLL_INTERVAL_MS=10000
RATE_LIMIT_BLOCK_SECONDS=3600

# Logging
LOG_MESSAGE_METADATA=false        # Log message metadata (sender, recipient, length)
LOG_USER_IDENTIFIERS=false        # Log actual user IDs (vs hashed)
LOG_HASH_SALT=2796127d573655228a0f9533cb6f1528f83b3462bbf4ad9911b9dfc0b98d653c    # Salt for hashing identifiers in logs

# Delivery Worker Configuration
ONLINE_CHANNEL=user_online_notifications:  # Redis Pub/Sub channel for user online notifications
DELIVERY_QUEUE_PREFIX=delivery_queue:
OFFLINE_QUEUE_PREFIX=offline:

# Kafka Configuration
KAFKA_ENABLED=true

KAFKA_PRODUCER_COMPRESSION=snappy
KAFKA_PRODUCER_LINGER_MS=5
KAFKA_PRODUCER_ACKS=all
KAFKA_PRODUCER_ENABLE_IDEMPOTENCE=false

KAFKA_TOPIC=construct-messages
KAFKA_CONSUMER_GROUP=delivery-workers

KAFKA_SSL_ENABLED=true
KAFKA_SASL_MECHANISM=SCRAM-SHA-256
KAFKA_SECURITY_PROTOCOL=SASL_PLAINTEXT

KAFKA_BROKERS=kafka.konstruct.cc:9092
KAFKA_SSL_ENABLED=true
KAFKA_SASL_USERNAME=CONSTRUCT_MESSENGER_BROKER
KAFKA_SASL_PASSWORD="jDOE(-tOSFSktSLW)ll+k5nfUE1lEC"

APNS_ENABLED=true
APNS_ENVIRONMENT=development
APNS_KEY_PATH=prkeys/AuthKey_TKYQ5KVW7P.p8
APNS_KEY_ID=TKYQ5KVW7P
APNS_TEAM_ID=PK2473XF3P
APNS_BUNDLE_ID=maximeliseyev.constructmessenger
APNS_DEVICE_TOKEN_ENCRYPTION_KEY=d912744da7ad232b7d1a48a51385c538d1337b557b549aca9b484e69ca9c83cd

# ============================================================================
# Federation and Domain Configuration
# ============================================================================
INSTANCE_DOMAIN=ams.konstruct.cc
FEDERATION_BASE_DOMAIN=ams.konstruct.cc
FEDERATION_ENABLED=false
ENABLE_MESSAGE_GATEWAY=true
DEEP_LINK_BASE_URL=https://ams.konstruct.cc

DELIVERY_ACK_MODE=kafka
DELIVERY_SECRET_KEY=a16cda790fc6c4eb031f1b552f2fb8839c3d0bbf999bc54d0de5bbaf6149dc21
DELIVERY_ACK_ENABLE_BATCHING=true  # Privacy protection
DELIVERY_ACK_BATCH_BUFFER_SECS=5
DELIVERY_EXPIRY_DAYS=7
DELIVERY_CLEANUP_INTERVAL_SECS=3600

LOG_MESSAGE_METADATA=false
LOG_USER_IDENTIFIERS=false

SERVER_SIGNING_KEY=g7P/rMDwefyMZ+axIHxYFLriZ3tNco9mmZd0HuC89nU=

MEDIA_HMAC_SECRET=925adaccd852f1e95bfdfba9f620f51951e41e25c4a3ccebf2d4adbea4a6c378
