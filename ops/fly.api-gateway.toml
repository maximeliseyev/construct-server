# fly.api-gateway.toml - API Gateway Service configuration
#
# API Gateway acts as a single entry point for all client requests.
# Handles:
# - JWT authentication verification
# - Rate limiting (IP-based, user-based)
# - CSRF protection
# - Request routing to appropriate microservices
#
# Architecture:
# - Stateless (can scale horizontally)
# - Routes requests to microservices based on path
# - Falls back to monolithic mode if microservices are disabled
#
# Deploy with: make deploy-api-gateway
# Or: fly deploy --config ops/fly.api-gateway.toml --app construct-api-gateway
#
# See https://fly.io/docs/reference/configuration/ for information about how to use this file.

app = 'construct-api-gateway'
primary_region = 'ams'

# Custom domain configuration
# To set up: fly certs add ams.konstruct.cc --app construct-api-gateway
# Then: fly domains add ams.konstruct.cc --app construct-api-gateway

[build]
  # Dockerfile path is specified via --dockerfile flag in Makefile

[processes]
  app = "gateway"

[env]
  # Rust logging level
  RUST_LOG = "info,sqlx=warn,construct_server=info"
  
  # Server configuration
  PORT = "8080"

  # Microservices configuration
  MICROSERVICES_ENABLED = "true"
  SERVICE_DISCOVERY_MODE = "static"
  SERVICE_TIMEOUT_SECS = "70"
  
  # Service URLs (will be set via secrets or internal DNS)
  # Note: Variable names must match what's used in microservices.rs
  AUTH_SERVICE_URL = "http://construct-auth-service.internal:8080"
  MESSAGING_SERVICE_URL = "http://construct-messaging-service.internal:8080"
  USER_SERVICE_URL = "http://construct-user-service.internal:8080"
  NOTIFICATION_SERVICE_URL = "http://construct-notification-service.internal:8080"
  
  # Circuit breaker configuration
  CIRCUIT_BREAKER_FAILURE_THRESHOLD = "5"
  CIRCUIT_BREAKER_SUCCESS_THRESHOLD = "2"
  CIRCUIT_BREAKER_TIMEOUT_SECS = "60"

  # Redis prefixes (needed for config parsing)
  ONLINE_CHANNEL = "user_online_notifications:"
  DELIVERY_QUEUE_PREFIX = "delivery_queue:"
  OFFLINE_QUEUE_PREFIX = "offline:"

[http_service]
  internal_port = 8080
  force_https = true
  auto_stop_machines = 'stop'
  auto_start_machines = true
  min_machines_running = 1
  processes = ["app"]

  # Health check endpoint
  [[http_service.checks]]
    grace_period = "5s"
    interval = "10s"
    method = "GET"
    path = "/health"
    timeout = "2s"
    protocol = "http"

# VM configuration - API Gateway is lightweight
[[vm]]
  memory = '512mb'
  cpus = 1

# Deployment strategy - rolling updates
[deploy]
  strategy = "rolling"
  max_unavailable = 1

# Auto-scaling based on request rate
[autoscaling]
  min_instances = 1
  max_instances = 10

  [[autoscaling.metrics]]
    type = "cpu"
    target = 70

  [[autoscaling.metrics]]
    type = "concurrency"
    target = 1000  # API Gateway can handle many concurrent requests

# Secrets to set via: make secrets-api-gateway
# Required secrets:
# - DATABASE_URL (for JWT verification, token invalidation) - REQUIRED
# - REDIS_URL (for rate limiting, CSRF tokens) - REQUIRED
# - JWT_SECRET (for JWT verification) - REQUIRED (min 32 chars)
# - JWT_ISSUER (for JWT verification) - Optional (default: "construct-server")
# - LOG_HASH_SALT (for hashing user IDs in logs) - REQUIRED
# - ONLINE_CHANNEL (Redis channel prefix) - REQUIRED
# - DELIVERY_QUEUE_PREFIX (Redis queue prefix) - REQUIRED
# - OFFLINE_QUEUE_PREFIX (Redis queue prefix) - REQUIRED
# - CSRF_SECRET (for CSRF token generation) - Optional (auto-generated if not set)
# 
# Note: APNS_DEVICE_TOKEN_ENCRYPTION_KEY is NOT required for API Gateway
# (only Notification Service needs it)

# Custom domain setup (optional):
# 1. Get app IPs: fly ips list --app construct-api-gateway
# 2. Add DNS records (A and AAAA) pointing to app IPs
# 3. Add SSL certificate: fly certs add ams.konstruct.cc --app construct-api-gateway
# 4. Set INSTANCE_DOMAIN secret: fly secrets set INSTANCE_DOMAIN=ams.konstruct.cc --app construct-api-gateway
# See DOMAIN_SETUP.md for detailed instructions
