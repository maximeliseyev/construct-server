# ============================================================================
# Construct Media Service - Fly.io Configuration
# ============================================================================
#
# Privacy-focused media storage service with:
# - gRPC streaming for uploads/downloads
# - No IP logging, no user tracking
# - Auto-deletion after TTL (15 days)
# - E2E encrypted blob storage only
#
# Deploy: flyctl deploy --config ops/fly.media.toml --app construct-media-staging
#
# ============================================================================

app = "construct-media-staging"
primary_region = "ams"

[build]
  dockerfile = "ops/Dockerfile.media"

# Command to run (single binary)
[processes]
  app = "media-service"

[env]
  RUST_LOG = "info,media_service=debug"
  # REST health check port
  MEDIA_BIND_ADDRESS = "0.0.0.0:8082"
  # gRPC service port
  MEDIA_GRPC_BIND_ADDRESS = "[::]:50056"
  # Storage configuration
  MEDIA_STORAGE_DIR = "/data/media"
  MEDIA_MAX_FILE_SIZE = "524288000"  # 500MB for videos
  MEDIA_FILE_TTL_SECONDS = "1296000"  # 15 days

# Persistent storage for media files (auto-expands)
[mounts]
  source = "media_storage"
  destination = "/data"
  initial_size = "10"  # 10GB initial

# HTTP service for REST health checks
[http_service]
  internal_port = 8082
  force_https = true
  auto_stop_machines = false
  auto_start_machines = true
  min_machines_running = 1
  processes = ["app"]
  
  [http_service.concurrency]
    type = "requests"
    hard_limit = 200
    soft_limit = 150

  [[http_service.checks]]
    interval = "30s"
    timeout = "5s"
    grace_period = "15s"
    method = "GET"
    path = "/health"

# gRPC service (separate from HTTP)
[[services]]
  protocol = "tcp"
  internal_port = 50056
  processes = ["app"]

  [[services.ports]]
    port = 443
    handlers = ["tls"]

  [[services.ports]]
    port = 50056
    handlers = []

  [[services.tcp_checks]]
    interval = "30s"
    timeout = "5s"
    grace_period = "15s"

# VM sizing for media handling (5GB RAM for large file processing)
[[vm]]
  memory = "4gb"
  cpu_kind = "shared"
  cpus = 2

# ============================================================================
# Secrets (set via flyctl secrets set --app construct-media-staging):
# ============================================================================
#
# Required:
#   DATABASE_URL - PostgreSQL connection string
#   MEDIA_HMAC_SECRET - Token signing secret (64 hex chars)
#
# Generate secrets:
#   flyctl secrets set MEDIA_HMAC_SECRET=$(openssl rand -hex 32) --app construct-media-staging
#   flyctl secrets set DATABASE_URL="postgres://..." --app construct-media-staging
#
# ============================================================================
