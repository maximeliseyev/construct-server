version: '3.8'

# Production deployment with Docker Secrets
# Deploy: docker stack deploy -c ops/docker-compose.prod.secrets.yml construct
# Requires: Docker Swarm initialized (docker swarm init)

services:
  envoy:
    image: construct-envoy:latest
    build:
      context: ..
      dockerfile: ops/Dockerfile
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    ports:
      - "443:443"
      - "9901:9901"
    volumes:
      - ../ops/envoy.prod.yaml:/app/envoy.yaml:ro
      - /etc/letsencrypt/live/ams.konstruct.cc:/etc/envoy/certs:ro
    command: /usr/local/bin/envoy -c /app/envoy.yaml --log-level info
    networks:
      - construct-net

  auth-service:
    image: construct-auth:latest
    build:
      context: ..
      dockerfile: ops/Dockerfile
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure
    command: /usr/local/bin/auth-service
    environment:
      - RUST_LOG=info,sqlx=warn
      - AUTH_GRPC_BIND_ADDRESS=0.0.0.0:50051
      # Secrets loaded from files
      - DATABASE_URL_FILE=/run/secrets/database_url
      - REDIS_URL_FILE=/run/secrets/redis_url
      - JWT_PRIVATE_KEY_FILE=/run/secrets/jwt_private_key
      - JWT_PUBLIC_KEY_FILE=/run/secrets/jwt_public_key
      - CSRF_SECRET_FILE=/run/secrets/csrf_secret
    secrets:
      - database_url
      - redis_url
      - jwt_private_key
      - jwt_public_key
      - csrf_secret
      - delivery_secret_key
      - media_hmac_secret
      - server_signing_key
      - log_hash_salt
    networks:
      - construct-net

  user-service:
    image: construct-user:latest
    build:
      context: ..
      dockerfile: ops/Dockerfile
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure
    command: /usr/local/bin/user-service
    environment:
      - RUST_LOG=info,sqlx=warn
      - USER_GRPC_BIND_ADDRESS=0.0.0.0:50052
      - DATABASE_URL_FILE=/run/secrets/database_url
      - REDIS_URL_FILE=/run/secrets/redis_url
      - JWT_PUBLIC_KEY_FILE=/run/secrets/jwt_public_key
    secrets:
      - database_url
      - redis_url
      - jwt_public_key
    networks:
      - construct-net

  messaging-service:
    image: construct-messaging:latest
    build:
      context: ..
      dockerfile: ops/Dockerfile
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure
    command: /usr/local/bin/messaging-service
    environment:
      - RUST_LOG=info,sqlx=warn
      - MESSAGING_GRPC_BIND_ADDRESS=0.0.0.0:50053
      - DATABASE_URL_FILE=/run/secrets/database_url
      - REDIS_URL_FILE=/run/secrets/redis_url
      - JWT_PUBLIC_KEY_FILE=/run/secrets/jwt_public_key
      - KAFKA_BROKERS=${KAFKA_BROKERS}
      - KAFKA_SASL_USERNAME=${KAFKA_SASL_USERNAME}
      - KAFKA_SASL_PASSWORD=${KAFKA_SASL_PASSWORD}
    secrets:
      - database_url
      - redis_url
      - jwt_public_key
    networks:
      - construct-net

  notification-service:
    image: construct-notification:latest
    build:
      context: ..
      dockerfile: ops/Dockerfile
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    command: /usr/local/bin/notification-service
    environment:
      - RUST_LOG=info,sqlx=warn
      - NOTIFICATION_GRPC_BIND_ADDRESS=0.0.0.0:50054
      - DATABASE_URL_FILE=/run/secrets/database_url
      - REDIS_URL_FILE=/run/secrets/redis_url
      - APNS_KEY_PATH=/run/secrets/apns_key
      - APNS_KEY_ID=${APNS_KEY_ID}
      - APNS_TEAM_ID=${APNS_TEAM_ID}
      - APNS_BUNDLE_ID=${APNS_BUNDLE_ID}
      - APNS_ENVIRONMENT=production
    secrets:
      - database_url
      - redis_url
      - apns_key
    networks:
      - construct-net

  invite-service:
    image: construct-invite:latest
    build:
      context: ..
      dockerfile: ops/Dockerfile
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    command: /usr/local/bin/invite-service
    environment:
      - RUST_LOG=info,sqlx=warn
      - INVITE_GRPC_BIND_ADDRESS=0.0.0.0:50055
      - DATABASE_URL_FILE=/run/secrets/database_url
      - REDIS_URL_FILE=/run/secrets/redis_url
      - JWT_PUBLIC_KEY_FILE=/run/secrets/jwt_public_key
    secrets:
      - database_url
      - redis_url
      - jwt_public_key
    networks:
      - construct-net

  delivery-worker:
    image: construct-worker:latest
    build:
      context: ..
      dockerfile: ops/Dockerfile
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure
    command: /usr/local/bin/delivery-worker
    environment:
      - RUST_LOG=info,sqlx=warn
      - DATABASE_URL_FILE=/run/secrets/database_url
      - REDIS_URL_FILE=/run/secrets/redis_url
      - KAFKA_BROKERS=${KAFKA_BROKERS}
      - KAFKA_SASL_USERNAME=${KAFKA_SASL_USERNAME}
      - KAFKA_SASL_PASSWORD=${KAFKA_SASL_PASSWORD}
      - APNS_KEY_PATH=/run/secrets/apns_key
      - APNS_KEY_ID=${APNS_KEY_ID}
      - APNS_TEAM_ID=${APNS_TEAM_ID}
      - APNS_BUNDLE_ID=${APNS_BUNDLE_ID}
      - APNS_ENVIRONMENT=production
    secrets:
      - database_url
      - redis_url
      - apns_key
    networks:
      - construct-net

networks:
  construct-net:
    driver: overlay

# External secrets (created via: ./scripts/create-secrets.sh)
secrets:
  database_url:
    external: true
    name: construct_production_database_url_v1
  redis_url:
    external: true
    name: construct_production_redis_url_v1
  jwt_private_key:
    external: true
    name: construct_production_jwt_private_key_v1
  jwt_public_key:
    external: true
    name: construct_production_jwt_public_key_v1
  csrf_secret:
    external: true
    name: construct_production_csrf_secret_v1
  delivery_secret_key:
    external: true
    name: construct_production_delivery_secret_key_v1
  media_hmac_secret:
    external: true
    name: construct_production_media_hmac_secret_v1
  server_signing_key:
    external: true
    name: construct_production_server_signing_key_v1
  log_hash_salt:
    external: true
    name: construct_production_log_hash_salt_v1
  apns_key:
    external: true
    name: construct_production_apns_key_v1
